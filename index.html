<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHALWAL POS | Professional Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --dominos-blue: #006491;
            --dominos-red: #E31837;
            --pending-dark-red: #8B0000;
            --dominos-gray: #f8f9fa;
            --success: #2ecc71;
            --light-green: #90EE90;
            --chair-color: #bdc3c7;
        }

        /* Expiry Overlay Styling */
        #expiryOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 99999; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; font-family: 'Segoe UI', sans-serif;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--dominos-gray); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; padding-bottom: 45px; }

        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow-x: auto; }
        
        header { 
            background: white; padding: 0 30px; height: 75px; display: flex; justify-content: space-between; 
            align-items: center; border-bottom: 4px solid var(--dominos-blue); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 1000px;
        }
        .logo-box { display: flex; align-items: center; gap: 12px; }
        .logo-img { height: 40px; }
        .brand-text { font-size: 1.5rem; font-weight: 900; color: var(--dominos-blue); }

        .top-nav { display: flex; gap: 10px; height: 100%; align-items: center; }
        .nav-link { 
            padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; 
            color: #555; text-decoration: none; display: flex; align-items: center; gap: 8px;
            transition: 0.2s; font-size: 1rem;
        }
        .nav-link:hover { background: #f0f2f5; }
        .nav-link.active { background: var(--dominos-blue); color: white; }

        .view { display: none; padding: 20px; height: calc(100vh - 120px); overflow-y: auto; min-width: 1000px; }
        .view.active { display: block; }

        .quick-access-bar { display: flex; gap: 15px; margin-bottom: 30px; padding: 10px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .quick-btn { flex: 1; height: 60px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 20px; padding: 10px 20px; justify-items: center; }
        
        .table-wrapper { position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s ease; }
        .table-wrapper:hover { transform: scale(1.08); }
        .table-card { width: 85px; height: 85px; background: white; border: 2px solid #ddd; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 2; box-shadow: 0 4px 8px rgba(0,0,0,0.08); }
        .chair { position: absolute; width: 28px; height: 28px; background: var(--chair-color); border-radius: 6px; z-index: 1; }
        .chair.top { top: 0; left: 50%; transform: translateX(-50%); }
        .chair.bottom { bottom: 0; left: 50%; transform: translateX(-50%); }
        .chair.left { left: 0; top: 50%; transform: translateY(-50%); }
        .chair.right { right: 0; top: 50%; transform: translateY(-50%); }
        .table-wrapper.available .table-card { border-top: 8px solid var(--success); }
        .table-wrapper.occupied .table-card { background: var(--dominos-red); color: white; border: none; }
        .table-wrapper.occupied .chair { background: #c0392b; }

        .tracker-header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .filter-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
        .stats-row { display: flex; gap: 20px; background: #f0f7ff; padding: 15px; border-radius: 8px; border: 1px solid #d0e4ff; margin-bottom: 15px; }
        .stat-item { flex: 1; text-align: center; }
        .stat-item h4 { margin: 0; color: #555; font-size: 0.8rem; text-transform: uppercase; }
        .stat-item p { margin: 5px 0 0; font-size: 1.2rem; font-weight: 900; color: var(--dominos-blue); }

        .tracker-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .history-item { background: #fff; border-left: 5px solid var(--dominos-blue); padding: 12px; border-radius: 6px; font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .history-item.pending { border: 1px solid var(--dominos-red); border-left: 8px solid var(--dominos-red); background: #fff1f1; }
        .history-item.pending * { color: var(--dominos-red) !important; }

        .order-container { display: grid; grid-template-columns: 70fr 30fr; gap: 20px; height: calc(100vh - 200px); }
        .card { background: white; padding: 25px; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        
        .billing-card { height: 100%; overflow-y: auto; padding: 12px; scrollbar-width: none; -ms-overflow-style: none; }
        .billing-card::-webkit-scrollbar { display: none; }
        .billing-card input, .billing-card select { padding: 8px 10px; font-size: 0.9rem; margin-bottom: 4px; border-radius: 6px; }

        .type-selector { display: flex; background: #f0f0f0; border-radius: 50px; padding: 5px; margin-bottom: 20px; flex-shrink: 0; }
        .type-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 50px; cursor: pointer; font-weight: bold; color: #777; font-size: 0.9rem; }
        .type-btn.active { background: var(--dominos-blue); color: white; }
        
        input, select { padding: 15px; border: 2px solid #edeff2; border-radius: 10px; font-size: 1.1rem; width: 100%; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--dominos-blue); background: #fcfdfe; }
        
        .qty-stepper { display: flex; align-items: center; gap: 5px; height: 45px; }
        .stepper-btn { 
            width: 45px; height: 45px; border: none; background: #edeff2; border-radius: 8px; 
            font-size: 1.5rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .stepper-btn:hover { background: #e2e5e9; }
        .stepper-input { width: 60px; height: 45px; text-align: center; font-size: 1.2rem; font-weight: bold; border: 2px solid #edeff2; border-radius: 8px; padding: 0; }

        .btn { padding: 15px 24px; border: none; border-radius: 50px; font-weight: 900; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .btn-blue { background: var(--dominos-blue); color: white; }
        .btn-green { background: var(--success); color: white; }
        .btn-add-item { border-radius: 10px; font-size: 1.2rem; width: 80px; }
        .btn-red { background: var(--dominos-red); color: white; width: 100%; padding: 12px; font-size: 1.1rem; margin-top: 8px; box-shadow: 0 4px 15px rgba(227, 24, 55, 0.3); flex-shrink: 0; }
        
        .item-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .item-table th { text-align: left; padding: 12px; border-bottom: 3px solid #f0f0f0; color: var(--dominos-blue); font-size: 0.85rem; text-transform: uppercase; }
        .item-table td { padding: 12px; border-bottom: 1px solid #f5f5f5; font-size: 1rem; }
        
        .summary-row { display: flex; justify-content: space-between; padding: 3px 0; font-weight: bold; color: #444; font-size: 0.9rem; align-items: center; }
        .total-banner { background: var(--dominos-blue); color: white; padding: 12px; border-radius: 10px; margin-top: 8px; flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }

        #modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; justify-content:center; align-items:center; }
        .modal { background:white; width:450px; border-radius:15px; padding:25px; position:relative; max-height: 90vh; overflow-y: auto; }
        .close-modal { position:absolute; top:15px; right:20px; font-size:25px; cursor:pointer; color:#bbb; }

        .credit-alert { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ffeeba; font-size: 0.85rem; display: none; }

        .help-ribbon {
            position: fixed; bottom: 0; left: 0; width: 100%; background: var(--light-green);
            color: #1b5e20; text-align: center; padding: 12px 0; font-weight: 900; font-size: 1.2rem;
            letter-spacing: 1.5px; z-index: 9999; box-shadow: 0 -3px 15px rgba(0,0,0,0.1);
            animation: helpBlink 2.5s infinite ease-in-out;
        }
        @keyframes helpBlink { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        .btn-action-text { 
            padding: 10px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; gap: 8px; border: none; cursor: pointer;
        }
        .btn-reset-visible { background: #eee; color: #555; padding: 10px 18px; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; }
    </style>
</head>
<body>

<div id="expiryOverlay">
    <i class="fas fa-exclamation-triangle" style="font-size: 5rem; color: var(--dominos-red); margin-bottom: 20px;"></i>
    <h1 style="color: #333;">Subscription Expired</h1>
    <p style="font-size: 1.2rem; color: #666;">Please Contact Developer to renew your license.</p>
</div>

<div id="modalOverlay"><div class="modal" id="modalContent"></div></div>

<div class="main-content">
    <header>
        <div class="logo-box">
            <img src="logo.png" alt="Logo" class="logo-img">
            <span class="brand-text">CHAWLAS2 <span style="color:var(--dominos-red)">BHAWANIGARH</span></span>
        </div>
        <nav class="top-nav">
            <div class="nav-link active" id="nav-dash" onclick="switchTab('dashView')"><i class="fas fa-th"></i> DASHBOARD</div>
            <div class="nav-link" id="nav-tracker" onclick="switchTab('trackerView')"><i class="fas fa-chart-line"></i> SALES TRACKER</div>
        </nav>
        <div id="clock" style="font-weight: bold; color: var(--dominos-blue); font-size: 1.1rem; text-align: right;"></div>
    </header>

    <div id="dashView" class="view active">
        <div class="quick-access-bar">
            <button class="btn btn-green quick-btn" onclick="openDirectOrder('Takeaway')"><i class="fas fa-bag-shopping"></i> START TAKEAWAY</button>
            <button class="btn btn-blue quick-btn" onclick="openDirectOrder('Delivery')"><i class="fas fa-truck"></i> START DELIVERY</button>
        </div>
        <h3 style="color: var(--dominos-blue); text-transform: uppercase; margin-bottom: 15px;">Dine-In Service Floor</h3>
        <div class="dashboard-grid" id="grid"></div>
    </div>

    <div id="trackerView" class="view">
        <div class="tracker-header">
            <div class="stats-row">
                <div class="stat-item"><h4>Total Sales</h4><p>₹<span id="statTotal">0.00</span></p></div>
                <div class="stat-item" style="border-left: 1px solid #ccc;"><h4>Cash</h4><p>₹<span id="statCash">0.00</span></p></div>
                <div class="stat-item" style="border-left: 1px solid #ccc;"><h4>UPI</h4><p>₹<span id="statUPI">0.00</span></p></div>
                <div class="stat-item" style="border-left: 1px solid #ccc; color: var(--dominos-red);"><h4>Pending</h4><p>₹<span id="statPending">0.00</span></p></div>
            </div>
            <div class="filter-row">
                <select id="timeFilter" onchange="renderHistory()" style="width: 150px;">
                    <option value="Daily">Today</option>
                    <option value="Weekly">This Week</option>
                    <option value="Monthly">This Month</option>
                    <option value="All">All Time</option>
                </select>
                <select id="methodFilter" onchange="renderHistory()" style="width: 150px;">
                    <option value="All">All Methods</option>
                    <option value="Cash">Cash</option>
                    <option value="UPI">UPI</option>
                    <option value="Pending">Pending</option>
                </select>
                <input type="text" id="searchBox" placeholder="Search Mobile or Name..." onkeyup="renderHistory()" style="flex-grow:1; max-width: 300px;">
                
                <button class="btn-action-text btn-blue" onclick="exportData()"><i class="fas fa-file-excel"></i> EXCEL REPORT</button>
                <button class="btn-action-text btn-green" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> IMPORT DATA</button>
                <input type="file" id="importFile" hidden onchange="importData(event)">
                <button class="btn-reset-visible" onclick="clearAllData()"><i class="fas fa-sync-alt"></i> CLEAR ALL</button>
            </div>
        </div>
        <div class="tracker-grid" id="historyList"></div>
    </div>

    <div id="orderView" class="view">
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
            <button class="btn btn-blue" onclick="switchTab('dashView')" style="padding: 10px 20px;"><i class="fas fa-arrow-left"></i></button>
            <h2 id="activeTableLabel" style="margin:0; color: var(--dominos-blue); font-size: 1.6rem;">ORDER</h2>
        </div>
        <div class="order-container">
            <div class="card">
                <div class="type-selector" id="orderTypeSelector">
                    <button class="type-btn active" id="btn-dine" onclick="setOrderType('Dine-In', this)">Dine-In</button>
                    <button class="type-btn" id="btn-takeaway" onclick="setOrderType('Takeaway', this)">Takeaway</button>
                    <button class="type-btn" id="btn-delivery" onclick="setOrderType('Delivery', this)">Delivery</button>
                </div>
                
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-end; flex-shrink:0;">
                    <div style="flex-grow: 4;">
                        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#666; font-size: 0.9rem;">Select Item</label>
                        <input list="menuOptions" id="itemInput" placeholder="Type dish name..." oninput="handleMenuSelect()" style="padding: 10px;">
                        <datalist id="menuOptions"></datalist>
                    </div>
                    <div style="flex-grow: 1;">
                        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#666; font-size: 0.9rem;">Price</label>
                        <input type="number" id="priceInp" placeholder="0.00" style="padding: 10px;">
                    </div>
                    <div>
                        <label style="display:block; margin-bottom:5px; font-weight:bold; color:#666; font-size: 0.9rem;">Qty</label>
                        <div class="qty-stepper">
                            <button class="stepper-btn" onclick="adjQty(-1)">-</button>
                            <input type="number" class="stepper-input" id="qtyValDisplay" value="1" min="1">
                            <button class="stepper-btn" onclick="adjQty(1)">+</button>
                        </div>
                    </div>
                    <button class="btn btn-blue btn-add-item" onclick="addItem()" style="height: 45px;"><i class="fas fa-plus"></i></button>
                </div>

                <div style="flex-grow: 1; overflow-y: auto; border-top: 1px solid #eee;">
                    <table class="item-table" id="orderTable">
                        <thead><tr><th>Item</th><th width="80">Qty</th><th width="100">Price</th><th width="120">Total</th><th width="50"></th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card billing-card">
                <div id="creditNotice" class="credit-alert">
                    <i class="fas fa-exclamation-triangle"></i> <strong>CREDIT ALERT:</strong> This customer has pending payments!
                </div>
                <h3 style="margin: 0 0 8px 0; color: var(--dominos-blue); border-bottom: 2px solid #f0f0f0; padding-bottom: 3px; flex-shrink:0;">Billing</h3>
                <div style="display: flex; flex-direction: column; gap: 5px; flex-shrink:0;">
                    <input type="text" id="cName" placeholder="Customer Name">
                    <input type="tel" id="cMobile" placeholder="Mobile Number" oninput="checkCredit(this.value)">
                    <select id="pMethod">
                        <option value="Cash">Cash Payment</option>
                        <option value="UPI">UPI / Online</option>
                        <option value="Pending">Credit (Pending)</option>
                    </select>
                </div>

                <div style="margin-top: 8px; border-top: 2px dashed #eee; padding-top: 8px; flex-grow:1;">
                    <div class="summary-row"><span>Subtotal</span><span>₹<span id="subtotalDisplay">0.00</span></span></div>
                    <div class="summary-row" style="color: var(--dominos-red);">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span>Disc (%)</span>
                            <input type="number" id="discountPercInp" value="0" oninput="updateOrderUI()" style="width: 50px; padding: 4px; font-size: 0.85rem; text-align: center;">
                        </div>
                        <span>-₹<span id="discountAmtDisplay">0.00</span></span>
                    </div>
                    <div class="summary-row"><span>SGST (2.5%)</span><span>₹<span id="sgstDisplay">0.00</span></span></div>
                    <div class="summary-row"><span>CGST (2.5%)</span><span>₹<span id="cgstDisplay">0.00</span></span></div>
                </div>

                <div class="total-banner">
                    <span style="font-size: 0.9rem; font-weight: bold; text-transform: uppercase;">Grand Total</span>
                    <h1 style="margin:0; font-size: 1.6rem;">₹<span id="totalDisplay">0.00</span></h1>
                </div>
                <button class="btn btn-red" onclick="finalizeBill()">FINALIZE & PRINT</button>
            </div>
        </div>
    </div>
</div>

<div class="help-ribbon">
    <i class="fab fa-whatsapp"></i> For Any Help Whatsapp - Nitish 9988344156
</div>

<script>
    // --- SUBSCRIPTION CHECK ---
    function checkSubscription() {
        const expiryDate = new Date('2026-07-01'); // Effective expiry after 2026-06-30
        const today = new Date();
        if (today >= expiryDate) {
            document.getElementById('expiryOverlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';
            return true;
        }
        return false;
    }

    const MENU = [
        { name: "Masala Chai", price: 49 },
        { name: "Elaichi Chai", price: 59 },
        { name: "Adrak Chai", price: 59 },
        { name: "Green Tea", price: 99 },
        { name: "Poha", price: 59 },
        { name: "Instant Coffee", price: 59 },
        { name: "Chholey Bhature", price: 159 },
        { name: "Paneer Prantha", price: 109 },
        { name: "Mix Prantha", price: 99 },
        { name: "Onion/Aloo Kulcha", price: 69 },
        { name: "Extra Chole", price: 45 },
        { name: "Extra Bhature", price: 55 },
        { name: "Momos Veg Steamed (6 PCS)", price: 99 },
        { name: "Momos Paneer Steamed (6 PCS)", price: 159 },
        { name: "Momos Chicken Steamed (6 PCS)", price: 159 },
        { name: "Momos Veg Fried (6 PCS)", price: 109 },
        { name: "Momos Paneer Fried (6 PCS)", price: 169 },
        { name: "Momos Chicken Fried (6 PCS)", price: 169 },
        { name: "Momos Veg Kurkure (6 PCS)", price: 129 },
        { name: "Momos Paneer Kurkure (6 PCS)", price: 189 },
        { name: "Momos Chicken Kurkure (6 PCS)", price: 189 },
        { name: "Momos Veg Chilli Garlic (6 PCS)", price: 149 },
        { name: "Momos Paneer Chilli Garlic (6 PCS)", price: 199 },
        { name: "Momos Chicken Chilli Garlic (6 PCS)", price: 199 },
        { name: "Veg Jalfrezi Roll", price: 139 },
        { name: "Paneer Tikka Roll", price: 159 },
        { name: "Malai Chaap Roll", price: 159 },
        { name: "Double Egg Roll", price: 99 },
        { name: "Chicken Tikka Roll", price: 169 },
        { name: "Vanilla/Chocolate Shake", price: 149 },
        { name: "Strawberry Shake", price: 149 },
        { name: "Oreo Shake", price: 169 },
        { name: "Kit Kat Shake", price: 169 },
        { name: "Tutti Frooti Shake", price: 169 },
        { name: "Masala Coke", price: 109 },
        { name: "Masala Lemonade", price: 119 },
        { name: "Mint Mojito", price: 159 },
        { name: "Kaala Khatta", price: 179 },
        { name: "Blue Lagoon", price: 179 },
        { name: "Lemon/Peach Ice Tea", price: 189 },
        { name: "Lassi (Sweet/Salted)", price: 79 },
        { name: "Fresh Lime Soda", price: 99 },
        { name: "Cold Coffee", price: 129 },
        { name: "Iced Cold Coffee", price: 119 },
        { name: "Caramel Cold Coffee", price: 139 },
        { name: "Roasted/Fried Papad (3pcs)", price: 55 },
        { name: "Masala Papad (3pcs)", price: 79 },
        { name: "Masala Peanut", price: 109 },
        { name: "Salted Fries", price: 125 },
        { name: "Peri Peri Fries", price: 145 },
        { name: "Manchow Soup (Veg)", price: 119 },
        { name: "Manchow Soup (Non-Veg)", price: 149 },
        { name: "Sweetcorn Soup (Veg)", price: 119 },
        { name: "Sweetcorn Soup (Non-Veg)", price: 149 },
        { name: "Special Non-Veg Soup", price: 169 },
        { name: "Onion Salad", price: 59 },
        { name: "Spring Time Green Salad", price: 89 },
        { name: "Kachumber Salad", price: 89 },
        { name: "Cream Salad", price: 99 },
        { name: "Plain Curd", price: 79 },
        { name: "Boondi Raita", price: 109 },
        { name: "Mix Raita", price: 119 },
        { name: "Pineapple Raita", price: 129 },
        { name: "Paneer Special Tikka", price: 329 },
        { name: "Mushroom Special Tikka", price: 329 },
        { name: "Chaap Special Tikka", price: 329 },
        { name: "Peri Peri Tikka-Paneer", price: 329 },
        { name: "Peri Peri Tikka-Mashroom", price: 329 },
        { name: "Peri Peri Tikka-Chaap", price: 329 },
        { name: "Lehsuni Tikka-Paneer", price: 339 },
        { name: "Lehsuni Tikka-Mashroom", price: 339 },
        { name: "Lehsuni Tikka-Chaap", price: 339 },
        { name: "Kali Mirch Tikka-Paneer", price: 339 },
        { name: "Kali Mirch Tikka-Mashroom", price: 339 },
        { name: "Kali Mirch Tikka-Chaap", price: 339 },
        { name: "Achari Tikka-Paneer", price: 339 },
        { name: "Achari Tikka-Mashroom", price: 339 },
        { name: "Achari Tikka-Chaap", price: 339 },
        { name: "Malai Tikka-Paneer", price: 339 },
        { name: "Malai Tikka-Mashroom", price: 339 },
        { name: "Malai Tikka-Chaap", price: 339 },
        { name: "Iam Stuffed Mushroom", price: 349 },
        { name: "Veg. Platter", price: 599 },
        { name: "Special Crispy Paneer", price: 289 },
        { name: "Spl. Tandoori Chicken (Half)", price: 329 },
        { name: "Spl. Tandoori Chicken (Full)", price: 529 },
        { name: "Tandoori Chicken Peri Peri (Half)", price: 329 },
        { name: "Tandoori Chicken Peri Peri (Full)", price: 529 },
        { name: "Tangri Chicken (Half)", price: 339 },
        { name: "Tangri Chicken (Full)", price: 539 },
        { name: "Spl. Afghani Chicken (Half)", price: 349 },
        { name: "Spl. Afghani Chicken (Full)", price: 549 },
        { name: "Kalmi Chicken", price: 359 },
        { name: "Stuffed Leg Chicken", price: 449 },
        { name: "Spl. Chicken Tikka (Half)", price: 249 },
        { name: "Spl. Chicken Tikka (Full)", price: 349 },
        { name: "Chicken Tikka Peri Peri (Half)", price: 249 },
        { name: "Chicken Tikka Peri Peri (Full)", price: 349 },
        { name: "Chicken Kali Mirch Tikka (Half)", price: 259 },
        { name: "Chicken Kali Mirch Tikka (Full)", price: 359 },
        { name: "Chicken Lehsuni Tikka (Half)", price: 259 },
        { name: "Chicken Lehsuni Tikka (Full)", price: 359 },
        { name: "Chicken Achari Tikka (Half)", price: 259 },
        { name: "Chicken Achari Tikka (Full)", price: 359 },
        { name: "Chicken Malai Tikka (Half)", price: 259 },
        { name: "Chicken Malai Tikka (Full)", price: 359 },
        { name: "Non-Veg Platter", price: 769 },
        { name: "Chicken Seekh Kebab", price: 249 },
        { name: "Special Reshmi Kebab", price: 399 },
        { name: "Mutton Seekh Kebab", price: 449 },
        { name: "Special Crispy Chicken", price: 299 },
        { name: "Fish Tikka / Amritsari / Ajwain / Lehsuni", price: 479 },
        { name: "Corn Salt and Pepper", price: 189 },
        { name: "Honey Chilli Potato", price: 199 },
        { name: "Honey Chilli Cauliflower", price: 209 },
        { name: "Veg Spring Roll", price: 199 },
        { name: "Crispy Cheese Corn Roll", price: 239 },
        { name: "Crispy Mushroom Sweet Chilli", price: 249 },
        { name: "Crispy Cottage Sticks", price: 249 },
        { name: "Hara Bhara Kebab", price: 269 },
        { name: "Crispy Paneer", price: 289 },
        { name: "Chilly Paneer (Gravy)", price: 359 },
        { name: "Veg Manchurian (Dry)", price: 299 },
        { name: "Chilly Paneer (Dry)", price: 329 },
        { name: "Veg Manchurian (Gravy)", price: 319 },
        { name: "Honey Chilli Crispy Chicken", price: 379 },
        { name: "Chilli Chicken (Boneless) (Dry)", price: 359 },
        { name: "Chilli Chicken (Boneless) (Gravy)", price: 379 },
        { name: "Chicken Manchurian (Dry)", price: 299 },
        { name: "Chicken Manchurian (Gravy)", price: 319 },
        { name: "Crispy Chicken", price: 299 },
        { name: "Chicken Finger", price: 329 },
        { name: "Noodles Veg", price: 189 },
        { name: "Noodles Egg", price: 199 },
        { name: "Noodles Chicken", price: 219 },
        { name: "Hakka Noodles Veg", price: 199 },
        { name: "Hakka Noodles Egg", price: 0 },
        { name: "Hakka Noodles Chicken", price: 229 },
        { name: "Paneer Noodles Veg", price: 219 },
        { name: "Paneer Noodles Egg", price: 0 },
        { name: "Paneer Noodles Chicken", price: 0 },
        { name: "Chilli Garlic Noodles Veg", price: 229 },
        { name: "Chilli Garlic Noodles Egg", price: 0 },
        { name: "Chilli Garlic Noodles Chicken", price: 249 },
        { name: "Chicken Lollipop (8 Pcs)", price: 329 },
        { name: "Honey Chilli Wings (8 Pcs)", price: 329 },
        { name: "Veg Fried Rice", price: 189 },
        { name: "Egg Fried Rice", price: 199 },
        { name: "Paneer Fried Rice", price: 219 },
        { name: "Chicken Fried Rice", price: 229 },
        { name: "SPL Cream Paneer (Kali Mirch Wala)", price: 359 },
        { name: "Paneer Lababdar", price: 359 },
        { name: "Malai Kofta", price: 359 },
        { name: "Rahra Paneer", price: 359 },
        { name: "Chilli Paneer / Mushroom / Chaap Gravy", price: 359 },
        { name: "Paneer / Mushroom / Chaap Do Pyaza", price: 339 },
        { name: "Butter Paneer / Mushroom / Chaap", price: 339 },
        { name: "Paneer / Mushroom / Chaap Butter Masala", price: 349 },
        { name: "Kadai Paneer / Mushroom / Chaap", price: 339 },
        { name: "Lemon Butter Paneer", price: 339 },
        { name: "Paneer Tikka Butter Masala", price: 349 },
        { name: "Shahi Paneer", price: 339 },
        { name: "Paneer Dhaniya Adraki", price: 349 },
        { name: "Paneer Bhurji", price: 299 },
        { name: "Jeera Aloo", price: 209 },
        { name: "Aloo Gobhi", price: 219 },
        { name: "Amritsari Pindi Chole", price: 269 },
        { name: "Special Mix Veg", price: 249 },
        { name: "Special Yellow Dal Tadka", price: 249 },
        { name: "Special Dal Makhni (Paki)", price: 289 },
        { name: "Plain Rice", price: 129 },
        { name: "Jeera Rice", price: 149 },
        { name: "Veg Pulao", price: 169 },
        { name: "Veg Biryani", price: 269 },
        { name: "Chicken Biryani", price: 329 },
        { name: "Chicken Tikka Biryani", price: 359 },
        { name: "Mutton Biryani", price: 449 },
        { name: "Butter Chicken (Quarter)", price: 299 },
        { name: "Chicken Curry (Quarter)", price: 299 },
        { name: "Kadai Chicken (Quarter)", price: 299 },
        { name: "Special Cream Chicken Kalamirch Walas (Half)", price: 449 },
        { name: "Special Chicken Rahra (Half)", price: 449 },
        { name: "Special Chicken Lababdar (Half)", price: 449 },
        { name: "Butter Chicken (Half)", price: 419 },
        { name: "Chicken Curry (Half)", price: 419 },
        { name: "Kadai Chicken (Half)", price: 419 },
        { name: "Lemon Butter Chicken (Half)", price: 419 },
        { name: "Chicken Tikka Butter Masala (Half)", price: 429 },
        { name: "Chicken Adraki (Half)", price: 429 },
        { name: "Chicken Do Pyaza (Half)", price: 429 },
        { name: "Masala Chicken (Half)", price: 429 },
        { name: "Special Cream Chicken Kalamirch Walas (Full)", price: 769 },
        { name: "Special Chicken Rahra (Full)", price: 769 },
        { name: "Special Chicken Lababdar (Full)", price: 769 },
        { name: "Butter Chicken (Full)", price: 719 },
        { name: "Chicken Curry (Full)", price: 719 },
        { name: "Kadai Chicken (Full)", price: 719 },
        { name: "Lemon Butter Chicken (Full)", price: 719 },
        { name: "Chicken Tikka Butter Masala (Full)", price: 729 },
        { name: "Chicken Adraki (Full)", price: 729 },
        { name: "Chicken Do Pyaza (Full)", price: 729 },
        { name: "Masala Chicken (Full)", price: 729 },
        { name: "Mutton Curry", price: 499 },
        { name: "Mutton Rogan", price: 499 },
        { name: "Mutton Kadai", price: 499 },
        { name: "Mutton Rahra", price: 549 },
        { name: "Egg Bhurji (4 pcs)", price: 209 },
        { name: "Egg Masala (2 pcs)", price: 219 },
        { name: "Egg Masala (4 pcs)", price: 299 },
        { name: "Egg Curry (2 pcs)", price: 219 },
        { name: "Egg Curry (4 pcs)", price: 299 },
        { name: "Thali Veg Deluxe", price: 249 },
        { name: "Thali Veg Executive", price: 289 },
        { name: "Thali Non-Veg Deluxe", price: 269 },
        { name: "Thali Non-Veg Executive", price: 299 },
        { name: "Dal Makhni + Rice or 2 Roti", price: 199 },
        { name: "Butter Paneer + Rice or 2 Roti", price: 199 },
        { name: "Veg Manchurian + Fried Rice or Noodles", price: 199 },
        { name: "Chilly Paneer + Fried Rice or Noodles", price: 209 },
        { name: "Butter Chicken + Rice or 2 Roti", price: 249 },
        { name: "Chilly Chicken + Fried Rice or Noodles", price: 249 },
        { name: "Chicken Manchurian + Fried Rice or Noodles", price: 219 },
        { name: "Tandoori Roti (Plain)", price: 20 },
        { name: "Tandoori Roti (Butter)", price: 25 },
        { name: "Missi Roti", price: 45 },
        { name: "Lacha Paratha", price: 45 },
        { name: "Tandoori Paratha", price: 69 },
        { name: "Plain Naan", price: 39 },
        { name: "Butter Naan", price: 45 },
        { name: "Garlic Naan", price: 59 },
        { name: "Cheese Naan", price: 179 },
        { name: "Keema Naan (Chicken)", price: 199 },
        { name: "GULAB JAMUN", price: 55 },
        { name: "ICE CREAM", price: 69 },
        { name: "MOONG DAL HALWA", price: 55 },
        { name: "CHOCO LAVA", price: 129 },
        { name: "SODA", price: 0 },
        { name: "Mineral Water", price: 0 }
    ];

    let tableData = JSON.parse(localStorage.getItem('dom_tables')) || {};
    if (Object.keys(tableData).length === 0) { resetTables(); }
    
    let salesHistory = JSON.parse(localStorage.getItem('dom_sales')) || [];
    let nextBillId = calculateNextId();
    let currentTable = null; 
    let currentDirectOrder = { items: [], type: 'Takeaway', discPerc: 0 };

    window.onload = () => {
        // Run expiry check
        if (checkSubscription()) return;

        const list = document.getElementById('menuOptions');
        MENU.forEach(item => { const opt = document.createElement('option'); opt.value = item.name; list.appendChild(opt); });
        renderGrid();
        renderHistory();
        setInterval(updateClock, 1000);
        updateClock();
    };

    function calculateNextId() {
        if (salesHistory.length === 0) return 1001;
        const ids = salesHistory.map(s => parseInt(s.BillID || s.id || 0)).filter(n => !isNaN(n));
        return ids.length === 0 ? 1001 : Math.max(...ids) + 1;
    }

    function resetTables() {
        tableData = {};
        for(let i=1; i<=21; i++) tableData[i] = { items: [], type: 'Dine-In', discPerc: 0 };
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = `${now.toLocaleTimeString()} | ${now.toLocaleDateString('en-GB')}`;
    }

    function switchTab(viewId) {
        if(checkSubscription()) return;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'dashView') { document.getElementById('nav-dash').classList.add('active'); renderGrid(); }
        else if (viewId === 'trackerView') { document.getElementById('nav-tracker').classList.add('active'); renderHistory(); }
    }

    function renderGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';
        for(let i=1; i<=21; i++) {
            const isBusy = tableData[i].items.length > 0;
            grid.innerHTML += `
                <div class="table-wrapper ${isBusy ? 'occupied' : 'available'}" onclick="openTable(${i})">
                    <div class="chair top"></div><div class="chair bottom"></div>
                    <div class="chair left"></div><div class="chair right"></div>
                    <div class="table-card">
                        <h2 style="margin:0">${i}</h2>
                        <span style="font-size:0.75rem; font-weight:bold; text-transform:uppercase">${isBusy ? 'BUSY' : 'FREE'}</span>
                    </div>
                </div>`;
        }
    }

    function checkCredit(mobile) {
        const alertBox = document.getElementById('creditNotice');
        if(!mobile || mobile.length < 5) { alertBox.style.display = 'none'; return; }
        const hasPending = salesHistory.some(s => s.Mobile == mobile && s.Method === 'Pending');
        alertBox.style.display = hasPending ? 'block' : 'none';
    }

    function openDirectOrder(type) {
        if(checkSubscription()) return;
        currentTable = null;
        currentDirectOrder = { items: [], type: type, discPerc: 0 };
        document.getElementById('activeTableLabel').innerText = type.toUpperCase() + " ORDER";
        switchTab('orderView');
        document.getElementById('creditNotice').style.display = 'none';
        document.getElementById('discountPercInp').value = 0;
        document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.innerText === type));
        document.getElementById('qtyValDisplay').value = "1";
        updateOrderUI();
    }

    function openTable(num) {
        if(checkSubscription()) return;
        currentTable = num;
        document.getElementById('activeTableLabel').innerText = "TABLE " + num;
        switchTab('orderView');
        document.getElementById('creditNotice').style.display = 'none';
        document.getElementById('discountPercInp').value = tableData[currentTable].discPerc || 0;
        document.querySelectorAll('.type-btn').forEach(b => b.classList.toggle('active', b.innerText === tableData[currentTable].type));
        document.getElementById('qtyValDisplay').value = "1";
        updateOrderUI();
    }

    function adjQty(amt) {
        let el = document.getElementById('qtyValDisplay');
        el.value = Math.max(1, (parseInt(el.value) || 0) + amt);
    }

    function setOrderType(type, btn) {
        if(currentTable) { tableData[currentTable].type = type; localStorage.setItem('dom_tables', JSON.stringify(tableData)); }
        else { currentDirectOrder.type = type; }
        document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function handleMenuSelect() {
        const found = MENU.find(m => m.name === document.getElementById('itemInput').value);
        if(found) { document.getElementById('priceInp').value = found.price; }
    }

    function addItem() {
        const name = document.getElementById('itemInput').value;
        const price = parseFloat(document.getElementById('priceInp').value);
        const qty = parseInt(document.getElementById('qtyValDisplay').value) || 1;
        if(!name || isNaN(price)) return;
        const newItem = { name, price, qty, total: price * qty };
        if(currentTable) { tableData[currentTable].items.push(newItem); localStorage.setItem('dom_tables', JSON.stringify(tableData)); }
        else { currentDirectOrder.items.push(newItem); }
        updateOrderUI();
        document.getElementById('itemInput').value = '';
        document.getElementById('priceInp').value = '';
        document.getElementById('qtyValDisplay').value = "1";
        document.getElementById('itemInput').focus();
    }

    function updateOrderUI() {
        const tbody = document.querySelector('#orderTable tbody');
        tbody.innerHTML = '';
        let subtotal = 0;
        let activeItems = currentTable ? tableData[currentTable].items : currentDirectOrder.items;
        activeItems.forEach((item, idx) => {
            const itemTotal = item.total || (item.price * (item.qty || 1));
            subtotal += itemTotal;
            tbody.innerHTML += `<tr><td><strong>${item.name}</strong></td><td>${item.qty || 1}</td><td>₹${item.price.toFixed(2)}</td><td><strong>₹${itemTotal.toFixed(2)}</strong></td><td align="right"><i class="fas fa-times-circle" style="color:var(--dominos-red); cursor:pointer; font-size:1.2rem;" onclick="removeItem(${idx})"></i></td></tr>`;
        });
        const perc = parseFloat(document.getElementById('discountPercInp').value) || 0;
        if(currentTable) tableData[currentTable].discPerc = perc;
        else currentDirectOrder.discPerc = perc;
        const discAmt = (subtotal * perc) / 100;
        const taxable = Math.max(0, subtotal - discAmt);
        const tax = taxable * 0.025; 
        document.getElementById('subtotalDisplay').innerText = subtotal.toFixed(2);
        document.getElementById('discountAmtDisplay').innerText = discAmt.toFixed(2);
        document.getElementById('sgstDisplay').innerText = tax.toFixed(2);
        document.getElementById('cgstDisplay').innerText = tax.toFixed(2);
        document.getElementById('totalDisplay').innerText = (taxable + (tax * 2)).toFixed(2);
    }

    function removeItem(idx) {
        if(currentTable) { tableData[currentTable].items.splice(idx, 1); localStorage.setItem('dom_tables', JSON.stringify(tableData)); }
        else { currentDirectOrder.items.splice(idx, 1); }
        updateOrderUI();
    }

    function finalizeBill() {
        if(checkSubscription()) return;
        let activeData = currentTable ? tableData[currentTable] : currentDirectOrder;
        if(activeData.items.length === 0) return alert("Please add some items first!");
        nextBillId = calculateNextId();
        const subtotal = activeData.items.reduce((a, b) => a + (b.price * (b.qty || 1)), 0);
        const perc = activeData.discPerc;
        const discAmt = (subtotal * perc) / 100;
        const taxable = subtotal - discAmt;
        const tax = taxable * 0.025;
        const bill = {
            id: nextBillId, BillID: nextBillId, Table: currentTable || "N/A", Type: activeData.type,
            Customer: document.getElementById('cName').value || "Guest",
            Mobile: document.getElementById('cMobile').value || "N/A",
            Items: [...activeData.items], Subtotal: subtotal, DiscPerc: perc, DiscAmt: discAmt,
            SGST: tax, CGST: tax, Total: (taxable + (tax * 2)), Method: document.getElementById('pMethod').value,
            Time: new Date().toLocaleTimeString(), Date: new Date().toLocaleDateString('en-GB'),
            RawDate: new Date().toISOString()
        };
        salesHistory.push(bill);
        printBill(bill);
        if(currentTable) { tableData[currentTable].items = []; tableData[currentTable].discPerc = 0; localStorage.setItem('dom_tables', JSON.stringify(tableData)); }
        else { currentDirectOrder = { items: [], type: 'Takeaway', discPerc: 0 }; }
        localStorage.setItem('dom_sales', JSON.stringify(salesHistory));
        document.getElementById('cName').value = '';
        document.getElementById('cMobile').value = '';
        document.getElementById('pMethod').value = 'Cash';
        switchTab('dashView'); 
        renderHistory();
    }

    function renderHistory() {
        const query = document.getElementById('searchBox').value.toLowerCase();
        const method = document.getElementById('methodFilter').value;
        const time = document.getElementById('timeFilter').value;
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        let tSales = 0, tCash = 0, tUPI = 0, tPend = 0;
        const now = new Date();
        salesHistory.filter(s => {
            const billDate = s.RawDate ? new Date(s.RawDate) : new Date();
            const matchesSearch = String(s.Mobile).includes(query) || (s.Customer || "").toLowerCase().includes(query);
            const matchesMethod = (method === 'All' || s.Method === method);
            let matchesTime = true;
            if(time === 'Daily') matchesTime = billDate.toDateString() === now.toDateString();
            else if(time === 'Weekly') {
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(now.getDate() - 7);
                matchesTime = billDate >= oneWeekAgo;
            } else if(time === 'Monthly') {
                matchesTime = billDate.getMonth() === now.getMonth() && billDate.getFullYear() === now.getFullYear();
            }
            const ok = matchesSearch && matchesMethod && matchesTime;
            if(ok) {
                const amt = parseFloat(s.Total);
                tSales += amt;
                if(s.Method === 'Cash') tCash += amt;
                else if(s.Method === 'UPI') tUPI += amt;
                else if(s.Method === 'Pending') tPend += amt;
            }
            return ok;
        }).reverse().forEach(s => {
            const isPending = s.Method === 'Pending' ? 'pending' : '';
            list.innerHTML += `<div class="history-item ${isPending}" onclick="showDetail(${s.BillID || s.id})">
                    <strong>Bill #${s.BillID || s.id} | ${s.Table !== "N/A" ? 'T'+s.Table : s.Type}</strong><br>
                    <span style="font-weight:bold;">Cust: ${s.Customer || "Guest"}</span><br>
                    <span style="font-size: 1.1rem; font-weight:bold; color:var(--dominos-blue)">₹${parseFloat(s.Total).toFixed(2)}</span><br>
                    <small>${s.Date} ${s.Time} | ${s.Method || s.Payment}</small>
                </div>`;
        });
        document.getElementById('statTotal').innerText = tSales.toFixed(2);
        document.getElementById('statCash').innerText = tCash.toFixed(2);
        document.getElementById('statUPI').innerText = tUPI.toFixed(2);
        document.getElementById('statPending').innerText = tPend.toFixed(2);
    }

    function clearPending(id) {
        const idx = salesHistory.findIndex(b => (b.BillID || b.id) == id);
        if(idx !== -1) {
            salesHistory[idx].Method = 'Cash';
            localStorage.setItem('dom_sales', JSON.stringify(salesHistory));
            closeModal();
            renderHistory();
            alert("Payment Cleared Successfully!");
        }
    }

    function showDetail(id) {
        const s = salesHistory.find(b => (b.BillID || b.id) == id);
        const modal = document.getElementById('modalContent');
        let itemRows = s.Items.map(i => {
            const price = i.price || (s.Subtotal / (s.Items.length || 1));
            return `<tr><td>${i.name} (x${i.qty || 1})</td><td align="right">₹${(price * (i.qty || 1)).toFixed(2)}</td></tr>`;
        }).join('');
        let payButton = (s.Method === 'Pending') ? `<button class="btn btn-green" style="width:100%; margin-top:10px;" onclick="clearPending(${s.BillID || s.id})"><i class="fas fa-check-circle"></i> MARK AS PAID (CASH)</button>` : '';
        modal.innerHTML = `<span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="color:var(--dominos-blue); margin-top:0;">Bill Details #${s.BillID || s.id}</h2>
            <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <p><strong>Customer:</strong> ${s.Customer}</p>
                <p><strong>Mobile:</strong> ${s.Mobile}</p>
                <p><strong>Date:</strong> ${s.Date} ${s.Time}</p>
                <p><strong>Type:</strong> ${s.Type} (${s.Table !== 'N/A' ? 'Table '+s.Table : 'No Table'})</p>
            </div>
            <table style="width:100%; font-size:0.9rem;">
                <thead><tr style="text-align:left; border-bottom:2px solid #eee;"><th>Item</th><th align="right">Amount</th></tr></thead>
                <tbody>${itemRows}</tbody>
            </table>
            <div style="margin-top:15px; border-top:2px solid #eee; padding-top:10px;">
                <div class="summary-row"><span>Discount:</span><span>₹${parseFloat(s.DiscAmt || 0).toFixed(2)}</span></div>
                <div class="summary-row"><span>GST:</span><span>₹${(parseFloat(s.SGST || 0) + parseFloat(s.CGST || 0)).toFixed(2)}</span></div>
                <div class="summary-row" style="font-size:1.2rem; color:var(--dominos-blue);"><span>Total:</span><span>₹${parseFloat(s.Total).toFixed(2)}</span></div>
            </div>
            <p style="margin-top:10px; font-weight:bold;">Payment Method: ${s.Method}</p>${payButton}
            <button class="btn btn-blue" style="width:100%; margin-top:10px;" onclick="printBill(${JSON.stringify(s).replace(/"/g, '&quot;')})">REPRINT BILL</button>`;
        document.getElementById('modalOverlay').style.display = 'flex';
    }

    function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }

    function printBill(bill) {
        const win = window.open('', '', 'width=300,height=600');
        let itemRows = bill.Items.map(i => {
            const price = i.price || (bill.Subtotal / (bill.Items.length || 1));
            return `<tr><td>${i.name}</td><td>${i.qty}</td><td>${(price * i.qty).toFixed(2)}</td></tr>`;
        }).join('');
        win.document.write(`<html><head><style>
                body { font-family: monospace; padding: 10px; width: 250px; }
                .center { text-align: center; }
                table { width: 100%; border-top: 1px dashed #000; border-bottom: 1px dashed #000; margin: 10px 0; font-size: 12px; }
                .total { font-weight: bold; font-size: 14px; }
                .footer { margin-top: 20px; font-size: 11px; }
            </style></head><body>
                <div class="center"><h2 style="margin:0">CHAWLAS2</h2><p style="font-size:10px; margin:5px 0;">The famous taste of Punjab</p><p>Bill #${bill.BillID || bill.id}</p></div>
                <div style="font-size:12px; border-top: 1px solid #eee; padding-top: 5px;">
                    <strong>CHAWLAS2:</strong> (BHAWANIGARH)<br>
					<strong>Near Barista Bhawanigarh,</strong> ,Sangrur<br>
					<strong>Highway,</strong> ,148026<br>
                    <strong>GSTIN:</strong> 03EEFPK9213G3ZN<br>
                    Date: ${bill.Date} ${bill.Time}<br>
                    Type: ${bill.Type} ${bill.Table !== 'N/A' ? '[Table '+bill.Table+']' : ''}<br>
					<strong>NAME:</strong> ${bill.Customer} [${bill.Mobile}]<br>
                </div>
                <table><thead><tr><th align="left">Item</th><th>Qty</th><th align="right">Amt</th></tr></thead><tbody>${itemRows}</tbody></table>
                <div style="font-size:12px;">Subtotal: ₹${parseFloat(bill.Subtotal).toFixed(2)}<br>
                    Disc (${bill.DiscPerc}%): -₹${parseFloat(bill.DiscAmt).toFixed(2)}<br>
                    SGST (2.5%): ₹${parseFloat(bill.SGST).toFixed(2)}<br>
                    CGST (2.5%): ₹${parseFloat(bill.CGST).toFixed(2)}<br>
                    <p class="total">GRAND TOTAL: ₹${parseFloat(bill.Total).toFixed(2)}</p>
                    <p>Method: ${bill.Method}</p>
                </div>
                <div class="center footer"><p>Thank you for your visit! 😊</p><p>📞 8054055541</p><p style="font-size:9px;">*** Visit Again ***</p></div>
            </body></html>`);
        win.document.close(); win.print(); win.close();
    }

    function exportData() {
        if(salesHistory.length === 0) return alert("No data to export!");
        const data = salesHistory.map(s => ({
            BillID: s.BillID || s.id, Date: s.Date, Time: s.Time, Customer: s.Customer, Mobile: s.Mobile, Type: s.Type, Table: s.Table,
            Items: s.Items.map(i => `${i.name}(x${i.qty})`).join(', '), Subtotal: s.Subtotal, Discount: s.DiscAmt, GST: (parseFloat(s.SGST || 0) + parseFloat(s.CGST || 0)), GrandTotal: s.Total, Method: s.Method
        }));
        const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Sales"); XLSX.writeFile(wb, `Sales_Report_${new Date().toLocaleDateString()}.xlsx`);
    }

    function importData(event) {
        const file = event.target.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet);
                const imported = json.map(row => {
                    let sub = parseFloat(row.Subtotal || 0);
                    let reconstructedItems = [];
                    if (row.Items) {
                        reconstructedItems = row.Items.split(', ').map(itemStr => {
                            const match = itemStr.match(/(.*)\(x(\d+)\)/);
                            const name = match ? match[1] : itemStr;
                            const qty = match ? parseInt(match[2]) : 1;
                            const estimatedPrice = sub / (row.Items.split(', ').length || 1) / qty;
                            return { name: name, qty: qty, price: estimatedPrice };
                        });
                    }
                    return {
                        id: parseInt(row.BillID), BillID: parseInt(row.BillID), Customer: row.Customer || "Guest", Mobile: row.Mobile || "N/A", Type: row.Type || "Takeaway", Table: row.Table || "N/A", Total: parseFloat(row.GrandTotal || 0), Subtotal: sub, DiscAmt: parseFloat(row.Discount || 0), SGST: parseFloat(row.GST || 0) / 2, CGST: parseFloat(row.GST || 0) / 2, Method: row.Method || "Cash", Date: row.Date || new Date().toLocaleDateString('en-GB'), Time: row.Time || new Date().toLocaleTimeString(), Items: reconstructedItems, RawDate: new Date().toISOString()
                    };
                });
                salesHistory = [...imported, ...salesHistory].filter((v, i, a) => a.findIndex(t => (t.BillID === v.BillID)) === i);
                localStorage.setItem('dom_sales', JSON.stringify(salesHistory)); nextBillId = calculateNextId(); renderHistory(); alert("Data Imported Successfully!");
            } catch(err) { alert("Error importing file!"); }
        }; reader.readAsArrayBuffer(file);
    }

    function clearAllData() {
        if(confirm("DANGER: This will permanently delete ALL sales history. Are you sure?")) {
            localStorage.removeItem('dom_sales'); salesHistory = []; nextBillId = 1001; renderHistory(); alert("All History Cleared.");
        }
    }
</script>
</body>

</html>

